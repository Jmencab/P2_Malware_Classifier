from tqdm import tqdm
import os
import operator as op
import csv
from csvFactory import DIR
try:
    import xml.etree.cElementTree as ET
except ImportError:
    import xml.etree.ElementTree as ET

features = []

def file_grams (n, datafile, direc, tags=True) :
  # convert file to tree
  tree = ET.parse(os.path.join(direc, datafile))
  # convert tree into tag list or byte list
  if tags == True:
    elList = []
    for el in tree.iter():
      elList.append(el.tag)
  else:
    bytestr = ET.tostring(tree.getroot(), encoding="UTF-8")
    elList = list(bytestr)
  # create list of all n_grams
  gram_list = zip(*[elList[i:] for i in range(n)])
  return gram_list

def find_feats (n, nbst, direc=DIR):
  gram_dict = dict()
  # add all grams from all files
  for datafile in tqdm(os.listdir(direc)):
    gram_list = file_grams (n, datafile, DIR)
    # create dictionary with n_grams and their values
    for el in gram_list:
      if el in gram_dict:
        gram_dict[el] += 1
      else:
        gram_dict[el] = 1
  # pick most frequent keys as features
  all_feats = sorted(gram_dict, key=gram_dict.get, reverse=True)
  return all_feats[:nbst]

def file_vals (n, nbst, datafile, direc) :
  global features
  if len(features) < n:
    features.append(find_feats (n, nbst))
  gram_list = file_grams (n, datafile, direc)
  vals = []
  for feat in features[n-1]:
    vals.append(gram_list.count(feat))
  return vals
